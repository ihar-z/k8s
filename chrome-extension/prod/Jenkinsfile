import java.io.BufferedReader
import java.io.InputStreamReader
import java.net.URL
import groovy.json.JsonSlurper

pipeline {
    agent {
        dockerfile { dir 'chrome-extension' }
    }
    options {
        timeout(time: 10)
    }
    stages {
        stage('Install') {
            steps {
//                sh 'sleep 2m'
                script {

                    def params = getVersions("vcd-amazon-alexa-skill")

                    env.VERSION = input(
                        message: "Enter version",
                        ok: "Publish",
                        parameters: [ [$class: 'ChoiceParameterDefinition', choices: params, description: 'Properties', name: 'prop'] ]
                    )
                }
                sh 'echo $VERSION'
            }
        }
    }
}

@NonCPS
def getVersions(moduleName) {
    def choices = []
    def url = new URL("http://nexus.crinfra.net:8081/nexus/service/rest/beta/search?name=" + moduleName)
    def conn = url.openConnection()
    conn.setDoOutput(true)

    def reader = new BufferedReader(new InputStreamReader(conn.getInputStream()))
    def results = new JsonSlurper().parseText(reader.getText());
    reader.close()

    results.items.each { data -> choices.push(data.version) }
    return choices.sort().join("\n")
}